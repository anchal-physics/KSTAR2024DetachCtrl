\section{Results}
\label{sec:results}

\input{figures/DetCtrl_2D_36161}

\input{figures/Prad_2D}

Utilizing the controllers tuned in Sec.\ref{sec:sysid}, we attempted detachment control experiments.
First, we used \Afrac{} controller in KSTAR \#35857 with results shown in Fig.\ref{fig:detctrl_afrac}.
As can be seen in Fig.\ref{fig:detctrl_afrac}a, the strike point remained within 12.5~mm of one of the probes of the real-time Langmuir probe array, thus the obtained \Afrac{} signal shown in Fig.\ref{fig:detctrl_afrac}b has error $\lesssim$13\%.
Here, we can see that the controller was successful in closely following the target provided to it completing the pre-programmed shot length to the end.
It is also evident that the aggressive control strategy was reasonable in that it provided a quick response to the initial change in the target value.
There are signs of small decaying oscillations which is a characteristic of a PID loop tuned for faster-than-critical response to reach the target quickly while causing minor decaying oscillations.
While the PID loop can be made less aggressive to critically approach the target, this generally comes at the cost of approximately half the speed with which it is possible to aggressively approach the target while remaining stable.
Here we chose to demonstrate an aggressive strategy but a slower strategy without any oscillations is also possible.
From 8~s to 10~s, it can be seen that the injected N$_2$ was just enough to ramp down the measured \Afrac{} with the same slope.
The accumulated offset from the target eventually caused the integral term to send a brief impulse of nitrogen near 9.8~s and then the controller further converged with the target value.
For the rest of the shot, small nitrogen puffs were required to correct the drifting \Afrac{} and keep it on the target.
The total radiated power from the plasma as measured by KSTAR \ac{IRVB} remained below 3.5~MW ($\approx$65\% of injected power) and as can be seen in Fig.\ref{fig:prad_2d}a (snapshot taken at around the time of maximum radiation), the majority of the radiation was coming from the divertor region and the core region was not losing power through radiation.
\fixme{This statement needs backing; just looking at the heatmap isn't enough. We should have pradcore and praddiv traces to make such a statement. Also, the core literally is losing some power. Just maybe not as much? But the volume is so much bigger that even with lower radiation density, it could be significant.}
This further validated, that \Afrac{} controller strategy first devised in Ref.\cite{Eldon_2022_PPCF} is a viable option for detachment control even with the tungsten divertor in KSTAR.

Since \Afrac{} controller has been demonstrated in the past as well, we decided to utilize the remaining allotted runtime on KSTAR to test the DivControlNN prototype-based controller.
Fig.\ref{fig:detctrl_sm} shows the results from shot \#36161 where we deployed this controller.
An immediate issue was seen with DivControlNN output that the initial heat flux calculation had a different starting value than what we saw in reference shots and system identification shot \#35854 (this shot appeared in figures~\ref{fig:sysid_sm} and \ref{fig:SM_inputs_35854}).
Because of this, when the controller turned on at 7.5~s, the large error resulted in the railing of gas command output which caused too much N$_2$ injected into the system.
While this quickly brought down the measured signal, it also resulted in an overshoot.
In the next ramp-down of the target from 10.5~s to 11.5~s, more impurity was injected as we tuned an aggressive controller.
It can be seen from \Afrac{} in Fig.\ref{fig:detctrl_sm}d that the system reached deep detachment by this point and the ion saturation current measurements (Fig.\ref{fig:detctrl_sm}a) were in the range where low sensitivity to further evolution would be expected beyond 12~s.
Increases in core radiated power seen in \ref{fig:detachctrl_sm}(e) may indicate a change in core plasma state from which recovery is not observed, as core $P_{rad}$ does not decrease later.
The decrease in power being conducted across the last closed flux surface does not help the controller follow the target back to higher heat flux, although the change in $P_{rad,core}$ is not so severe as to fully explain this.
%In post-analysis of IRVB inverted data as shown in Fig.\ref{fig:prad_2d}, we can see that the core started radiating a lot of power after the last railed impulse of gas input between 10.8~s to 12~s (Fig.\ref{fig:prad_2d}c), whereas \#36161 with DivControlNN heat flux control was similar to \#35857 with \Afrac{} control prior to that (Fig.\ref{fig:prad_2d}b vs Fig.\ref{fig:prad_2d}a).
%This would have reduced $P_{SOL}$ (power entering SOL from core) and started to starve the divertor of power, contributing to the failure to follow the rising heat flux target shown in Fig.\ref{fig:detctrl_sm}b between 13 and 15~s.
A stronger driver for the failure to reattach when the heat flux target was increased is probably that the walls were saturated with nitrogen under heavy puffing.
Clean walls are effective at pumping nitrogen as it sticks to them, but heavily saturated walls release nitrogen and can act as a source after gas flow is turned off.
Even if the walls are only a weak or negligible source, they will be much less effective at particle removal and thus nitrogen inventory will not decrease quickly enough to follow a reattaching control target.
Inefficient pumping compared to puffing is a known challenge to control that relies on gas as the primary actuator \cite{Eldon_2017_NF,eldon_2025_ppcf}.
This type of nonlinear response also increases the risk of running an aggressive controller as periods of excess seeding may be difficult to recover from; tuning choices that could be preferable in other contexts are not necessarily the best for detachment control.
\fixme{Check for changes in ELMs that might have increased tungsten influx to the core; this peaked on-axis radiation looks like tungsten. Detaching more deeply shouldn't increase tungsten sputtering, but messing with the pedestal could increase penetration of tungsten that's floating around the edge, anyway. Or reduce flushing of tungsten that penetrates.}
% \textcolor{red}{Comment on hysteresis stemming from interaction between core and impurity seeding for divertor management? I'll write something if I can find the right words.}
There is no surprise with the fact that setting target values for an uncalibrated output is not always deterministic and would cause issues as we faced.

\begin{figure}
\centering
\includegraphics[width=\linewidth]{figures/correlation_smq_afrac.pdf}
\caption{DivControlNN heat flux versus $A_{frac}$ (a) and $n_e$ (b).
$A_{frac}$ has been renormalized to use the same correction coefficient in all cases.
The top legend gives Pearson $r$ values for each shot individually.
When all the data shown in panel (a) are aggregated, they have $r=0.62$.
Times are from 6.2~s to the end of each shot.
\#35854 was a feedforward system ID shot and \#36159 was unseeded; the others used detachment control.
}
\label{fig:correlation}
\end{figure}

Post-shot data analysis discovered further issues in our operation of the DivControlNN model.
The impurity fraction calculation as mentioned in Sec.\ref{sec:control_variables} malfunctioned and sent a constant zero input to the model (see Fig.\ref{fig:SM_inputs_35854}e).
Thus the model was unable to respond directly to large amounts of impurity that were injected into the system and was only relying on data from line-integrated core electron density, input power, and plasma current as real-time inputs.
Figure~\ref{fig:correlation}(a) shows the correlation between $A_{frac}$ and DivControlNN heat flux, showing that indeed the lowest heat flux values go with the lowest $A_{frac}$, and the highest heat flux samples are the most attached.
In the middle, however, there is an awkward step-like quality which may have been perceptible in figure~\ref{fig:detctrl_sm}(b).
This is explained by the relationship between predicted heat flux and input density in figure~\ref{fig:correlation}(b) as two regions of insensitivity to $n_e$ are apparent from about $n_e=$ 2.85--3.05 and 3.50--3.85.
Panel (b) also has a secondary curve below the primary sequence; these samples occurred at lower input power which occurred since some heating sources were not maintained until the end of every discharge.
The approximate alignment of one of the low power segments with the primary sequence section from $n_e=$ 3.05--3.50 is coincidental.
The regions of insensitivity are not desirable in a control variable and probably caused the most trouble when the DivControlNN target was set close to just below 6 from $t=11.5$--13~s in \#36161; in particular, encounter with the insensitivity from 11.5--12~s lead to an inappropriate excess in the gas command and subsequent overshooting when the heat flux output began to decrease again.
The insensitive regions reflect features observed in the UEDGE database and are being investigated.
If this is not resolved within UEDGE or within the neural network itself, an added layer could be added to eliminate these artifacts before the predicted heat flux reaches a controller.
Despite these limitations, this preliminary tests were able to regulate detachment as confirmed by the probes, and the limitations themselves highlight issues to watch for in subsequent iterations of DivControlNN or when constructing related tools.

\begin{figure*}[!ht]
\centering
\includegraphics[width=\textwidth]{figures/beta_vs_dod.pdf}
\caption{
Normalized $\beta$ plotted versus degree of detachment $DOD=1/A_{frac}$.
$A_{frac}$ has been renormalized so that all shots have the same empirical correction factor.
For seeded shots, the time range is from $t=6.0$~s until $I_p$ begins to drop.
For unseeded shots, values are averaged over $6.0<t<8.0$~s.
Vertical lines are placed as guides at $DOD = 1, 2, 5$, and 9, corresponding to guides and the axis limit of figure 12 of \cite{Eldon_2022_PPCF}.
Horizontal black lines mark typical $\beta_N$ values of attached shots in this scenario as well as various levels of degradation (see legend).
Unseeded shots are marked by opaque diamonds giving their average values over a period of steady performance during the $I_p$ flattop.
}
\label{fig:beta_vs_dod}
\end{figure*}

Figure~\ref{fig:beta_vs_dod} shows how detachment with nitrogen seeding affects core plasma performance.
As this scenario is based on the previous scenario used with the carbon divertor, trends are similar: 20\% drop in $\beta_N$ at $DOD\approx 5$ and 30\% drop at $DOD\sim 9$ compared to the average $\beta_N$ value for unseeded shots.
However, the initial loss of $\beta$ at $DOD\approx 2$ is greater at $\approx 15$\% in these recent shots in the tungsten vertical divertor compared to $\approx 10$\% for nitrogen-seeded shots at $DOD=2$ in the carbon central-slant divertor.
We note that detachment control with deuterium in the carbon divertor resulted in $\beta_N$ dropping in $\approx 15$--$20$\% at $DOD=2$, and attribute this faster initial drop to deuterium puffing as a less efficient actuator for detachment than impurity seeding.
%Some shots (\#36161 and \#36162) start at lower $\beta_N$ (prior to any seeding) than the unseeded baseline shot of the same day (\#36159) or any of the other shots shown.
Perhaps lack of a local carbon sputtering source at the strike point requires more nitrogen be added to initiate detachment, but deeper detachment levels are similar as both cases (C and W divertors) have nitrogen as the dominant impurity by then, and also sputtering of carbon at the strike point will be reduced by detachment.
The general trend of performance changes during detachment seems to be dominated by the core scenario, as seen in figure~5 of \cite{wang_2021_pop}.
Isolated detachment control systems like the ones presented here primarily control motion along the $\beta$ vs $DOD$ curves set by the scenario, although some hysteresis is evident in the discharges that used feed-forward control (magenta and purple).
In \#35853, returning from $DOD>10$ to $DOD\sim5$ did not proceed along the original curve, but instead some permanent loss of $\beta$ occurred.
A simple, single-in, single-out controller (SISO), if properly configured, should be able to prevent deleterious changes to the core scenario like this by avoiding unnecessarily deep detachment and over seeding.
SISO controllers were used to control detachment in the high $\beta_p$ scenario shown in \cite{wang_2021_pop} figure~5, and consistent with the trends shown in that figure, they delivered deep detachment without confinement degradation (but with a problematic level of fuel dilution) \cite{Eldon_2021_NME}.
It may be possible for an isolated detachment controller to change the $\beta$ vs $DOD$ curve by injeting fuel in addition to an impurity species in a single-in, multi-out scheme.
This strategy may be able to increase the dissipation efficiency of the seeded impurity and reduce fuel dilution and undesirable side effects of impurity-induced detachment because $P_{rad}=n_e n_Z L_Z(T_e)$: impurity density $n_Z$ is not the only tool at our disposal.


% In the past it has been seen that puffing deuterium is sufficient to attain partial detachment \cite{Loarte_1998_NF, Eldon_2017_NF} when the plasma facing wall is made of carbon.
% Such wall can create an intrinsic source of carbon due to sputtering due to ELMS.
% Such intrinsic impurity population can drive detachment through increased electron density as radiated power due to impurity is given by $P_{rad}=n_e n_Z L_Z(T_e)$ where $n_e$ is electron density, $n_Z$ is ion density, and $L_Z(T_e)$ is the radiative loss function for the impurity ion.
% Thus, in the presence of some intrinsic impurity
% \textcolor{red}{No, not deuterium alone. Deuterium \emph{puffing} alone can do it, if there's a carbon wall to sputter to make a carbon source to go with the deuterium puff. KSTAR still has a carbon main wall that could do it. Also, $P_{rad}=n_e n_Z L_Z(T_e)$, so changing $n_e$ when you have some background impurity will do it. So yes, puffing deuterium in the presence of some fixed impurity population will drive detachment, even if the D2 doesn't trigger any additional sputtering related impurity influx. The ELMs will have knocked carbon off the main chamber wall. Then increasing deuterium density in the divertor will increase $n_e$ and therefore $P_{rad}$. Be precise about these things. The results you quoted were from carbon-walled devices. Not for this paper per se but for fun, check ASDEX Upgrade results to see if detachment can be achieved with D2 only puffing in full tungsten.}
% This might be the case with shot \#36161, that the model inference with zero impurity fraction input still reported a decrease in estimated heat flux as the electron density input increased with N$_2$ puffing.
% % \textcolor{red}{Did they put background carbon in? Although the seeded impurity (neon I think in that version of DivControlNN) may have been 0, the intrinsic impurity might not have been.} No there was no intrinsic impurity in the sims
% The only other changeable input, input power, mostly remained constant during flat top of the shot.
% However, as the amount of total puffed N$_2$ increased, the pure deuterium plasma case from which the model must be infering the heat flux would deviate and thus the control is not very good beyond 11s.
% \textcolor{red}{I don't think this logic holds up. The control variable might not correlate well with reality if changes in impurity fraction become too large, but if it still responds similarly to the control actuator, that shouldn't be a barrier to control. It's not clear that you can blame deficiencies in control performance on this.}
% Despite these limitations, this preliminary test sheds light on the potential of using such a surrogate model-based controller for detachment control in future reactors.
